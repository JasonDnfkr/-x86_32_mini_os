### 9 fork

fork实现分以下几步完成:
第一步是在系统调用表sys_table中添加系统调用接口，调用相关的系统调用接口，此步和上一章中介绍的方法一致。
第二步是分配子进程运行所需的任务控制块task_t，为此需要为系统中所有运行的进程提前建立好task_table。当有新进程建立时，从该表中分配task_t结构。
第三步是初始化task t，其关键之处在于要让该结构体中的内容，除tss->eax以外，其它内核寄存器的值要与父进程中的相同，这样才能完整的复制父进程调用fork前的状态。如此一来，子进程运行时，才能恢复成父进程中调用fork时的运行状态。
第四步是需要单独为子进程分配相应的内容空间，即内核页表及相应的物理页。这样就可以使子进程拥有独立的运行内存空间。

> Tips
>
> 1. 直接拿到 struct syscall_frame_t 的地址：parent_task->tss_esp0 - sizeof(syscall_frame_t)
>
> <img src="10 fork_pic/image-20230322210545196.png" alt="image-20230322210545196" style="zoom: 50%;" /> 
>
> 2. 在为子进程创建用户地址空间时，只需要扫描父进程中0x80000000以上存在的内存映射区域就行。因为下半段是内核，地址都是共用的。





