### 9 exec

#### 1 C程序入口点

做了一个C运行库，包裹住了main函数。写了一个链接脚本，把shell目录下的程序和C库代码链接加载。

#### 2 fd接口

在内存中设置了一块区域，模拟打开的文件。设置文件描述符FD为1。

并设置了一些系统调用，针对这个文件描述符和该文件缓冲区来做操作。

#### 3 execve

exec 的过程，实则就是：

创建一个新的页表，把elf程序加载到那个页表里面的内存里，并同时建立新的映射，然后销毁旧内存。

对于exec出来的用户进程，还要分配用户栈；对于旧的进程，要正常从exec里退出。可以把旧进程的内核栈分给新用户进程，然后修改一下内核栈里的现有的寄存器，让它把现场转移至新的进程里。

对于用户栈，esp设置为0xE0000000

由于跳转的地址是新的C入口函数，它执行main(int, char**)时会进行函数参数传递，会取栈指针以上的信息。但是当前还没有放参数进去

<img src="11 exec_pic/image-20230323192149150.png" alt="image-20230323192149150" style="zoom:50%;" />

把栈的内容这样设置，可以方便地取地址。所以设置的esp不能是0xE0000000，要预留一点空间。

然后需要实现一个复杂的功能`copy_args`，需要把execve的参数从用户空间拷贝至另一个用户空间，也就是拷贝页表
